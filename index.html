<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Hands</title>
    <link rel="manifest" href="manifest.json">

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/math/sw.js');
    });
  }
</script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background-color: #f0f4f8; margin: 0; padding: 10px; touch-action: manipulation; }
        #exercise { font-size: 50px; margin: 10px; font-weight: 800; color: #2c3e50; }
        
        .btn {
            font-size: 24px;
        }
        #settings-trigger { position: absolute; top: 5px; right: 5px; font-size: 16px; cursor: pointer; z-index: 10; background: none; border: none; }
        .setting-row { margin: 20px; font-size: 22px; display: flex; align-items: center; gap: 15px; }
        .settings-inner-box {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Key: Aligns children to the left */
            gap: 20px;
            margin-bottom: 30px;
        }
        input[type="checkbox"] { width: 25px; height: 25px; cursor: pointer; }

        #overlay, #settings-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); 
                   display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }

        #settings-modal { display: none; z-index: 101; }
        #start-btn { padding: 20px 40px; font-size: 30px; background: #3498db; color: white; border: none; border-radius: 50px; cursor: pointer; }

        .game-container { display: flex; justify-content: center; gap: 10px; margin-top: 5px; min-height: 210px; }
        .hand-wrapper { display: flex; flex-direction: column; align-items: center; }
        
        svg { width: 150px; height: 200px; transition: all 0.3s; touch-action: none; }
        .finger { fill: #ffdbac; stroke: #8d5524; stroke-width: 2; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .finger.counted { fill: #ffad60; }
        .palm { fill: #ffdbac; stroke: #8d5524; stroke-width: 2; -webkit-tap-highlight-color: transparent; }
        
        .finger-label { font-size: 24px; font-weight: bold; fill: #ffffff; pointer-events: none; text-shadow: 1px 1px 2px #000; }
        
        #options-container { display: flex; justify-content: center; flex-wrap: wrap; column-gap: 55px; row-gap: 20px; visibility: hidden; }
        .vehicle-btn { display: flex; flex-direction: column; align-items: center; background: white; border: 3px solid #3498db; 
                       border-radius: 15px; padding: 8px; width: 70px; -webkit-tap-highlight-color: transparent; }
        .vehicle-btn .icon { font-size: 30px; }
        .vehicle-btn .num { font-size: 20px; font-weight: bold; }

        #message { font-size: 22px; color: #4CAF50; font-weight: bold; height: 30px; margin-top: 10px; }

        @media (min-width: 768px) {
            #exercise { font-size: 100px; }
            svg { width: 250px; height: 320px; }
            .game-container { gap: 80px; min-height: 330px; }
            .vehicle-btn { width: 120px; padding: 20px; }
            .vehicle-btn .icon { font-size: 50px; }
            .vehicle-btn .num { font-size: 32px; }
        }
    </style>
</head>
<body>

    <button id="settings-trigger" onclick="toggleSettings(true)">‚öôÔ∏è</button>

    <div id="overlay">
        <h1>Ready to Count?</h1>
        <button id="start-btn" onclick="startGame()">START GAME</button>
    </div>

    <div id="settings-modal">
        <h2>Settings</h2>
        <div class="settings-inner-box">
            <div class="setting-row">
                <input type="checkbox" id="forcePalm">
                <label for="forcePalm">Must click first hand palm first</label>
            </div>
            <div class="setting-row">
                <input type="checkbox" id="includeZeros">
                <label for="includeZeros">Include zeros</label>
            </div>
        </div>
        <button class="btn" onclick="closeSettings()">Close & Save</button>
    </div>

    <div id="exercise">---</div>
    <div class="game-container">
        <div class="hand-wrapper"><svg id="leftHand" viewBox="0 0 200 250"></svg></div>
        <div class="hand-wrapper"><svg id="rightHand" viewBox="0 0 200 250"></svg></div>
    </div>
    <div id="message"></div>
    <div id="options-container"></div>

    <script>
        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
        let num1 = 0, num2 = 0, globalCounter = 0, isTransitioning = false;
        const vehicles = [
            'üöó', 'üöï', 'üöô', 'üöå', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöú', 'üö≤', 'üöÇ', '‚úàÔ∏è', 'üöÄ', 'üö¢',
            'üõµ', 'üèçÔ∏è', 'üõ∫', 'üöû', 'üöÅ', 'üõ∏', 'üõ∂', '‚õµ', 'üö§', 'üõ≥Ô∏è', 'üöö', 'üöõ', 'üõª', 'üö≤', 
            'üõ¥', 'üõπ', 'üö†', 'üöü', 'üöã', 'üõ∞Ô∏è', 'üèóÔ∏è', 'üöú'
        ];
        const fingerData = [{x:20,y:80,w:28,h:75},{x:55,y:30,w:28,h:95},{x:90,y:10,w:28,h:105},{x:125,y:30,w:28,h:95},{x:160,y:70,w:28,h:65}];
        let isHandClicked;
        let forcePalmFirst = localStorage.getItem('forcePalmFirst') === 'true';
        let includeZeros = localStorage.getItem('includeZeros') === 'true';
        function startGame() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('forcePalm').checked = localStorage.getItem('forcePalmFirst') === 'true';
            document.getElementById('includeZeros').checked = localStorage.getItem('includeZeros') === 'true';
            newGame();
        }

        function closeSettings() {
            localStorage.setItem('forcePalmFirst', document.getElementById('forcePalm').checked);
            localStorage.setItem('includeZeros', document.getElementById('includeZeros').checked);
            forcePalmFirst = document.getElementById('forcePalm').checked;
            includeZeros = document.getElementById('includeZeros').checked;
            if (forcePalmFirst) {
                newGame(); // Restart game with new logic
            }
            document.getElementById('settings-modal').style.display = 'none';
        }
        function toggleSettings() {
            document.getElementById('settings-modal').style.display = 'flex';
        }

        function speak(text, callback) {
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'en-US';
            if (callback) msg.onend = callback;
            window.speechSynthesis.speak(msg);
        }

        function drawHand(handId, fingerCount, isLeftHand) {
            const svg = document.getElementById(handId);
            svg.innerHTML = '';
            // if(fingerCount === 0) return; // Don't draw if 0

            const palm = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            palm.setAttribute("x", "30"); palm.setAttribute("y", "120");
            palm.setAttribute("width", "140"); palm.setAttribute("height", "100");
            palm.setAttribute("rx", "20");
            palm.setAttribute("class", "palm clickable-palm");
            
            const handlePalm = () => { countWholeHand(handId, fingerCount); };
            palm.onclick = handlePalm;
            palm.ontouchstart = (e) => { e.preventDefault(); handlePalm(); };
            
            svg.appendChild(palm);

            for (let i = 0; i < 5; i++) {
                if (i < fingerCount) {
                    const f = fingerData[i];
                    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute("x", f.x); rect.setAttribute("y", f.y);
                    rect.setAttribute("width", f.w); rect.setAttribute("height", f.h);
                    rect.setAttribute("rx", "12");
                    rect.setAttribute("class", "finger");
                    
                    const handleFinger = (e) => {
                        e.stopPropagation();
                        if (forcePalmFirst && !isHandClicked) {
                            speak("Try clicking the palm to count the whole hand!");
                            return;
                        }
                        countSingleFinger(rect, true);
                    };
                    rect.onclick = handleFinger;
                    rect.ontouchstart = (e) => { e.preventDefault(); handleFinger(e); };
                    
                    svg.appendChild(rect);
                }
            }
        }

        function countSingleFinger(rect, shouldSpeak) {
            if (rect.classList.contains('counted') || isTransitioning) return;
            // if (isHand) {
                // globalCounter += rect.parentNode.querySelectorAll('.finger').length;
            // } else {
                globalCounter++;
            // }
            rect.classList.add('counted');
            const svg = rect.parentNode;
            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("x", parseInt(rect.getAttribute("x")) + 7);
            text.setAttribute("y", parseInt(rect.getAttribute("y")) + 35);
            text.setAttribute("class", "finger-label");
            text.textContent = globalCounter;
            svg.appendChild(text);
            shouldSpeak && speak(globalCounter);
            if (globalCounter === (num1 + num2)) showOptions();
        }

        function countWholeHand(handId, count) {
            if (isTransitioning || isHandClicked) return;
            isHandClicked = true;

            if (document.getElementById('leftHand').querySelectorAll('.finger').length === 0 &&
                document.getElementById('rightHand').querySelectorAll('.finger').length === 0) {
                showOptions();
            }

            const svg = document.getElementById(handId);
            const uncounted = svg.querySelectorAll('.finger:not(.counted)');
            if (uncounted.length > 0) {
                for (let i = 0; i < uncounted.length; i++) {
                    countSingleFinger(uncounted[i], i === uncounted.length - 1)
                }
            }
        }

        function showOptions() {
            // document.getElementById('message').textContent = "Pick the vehicle!";
            const container = document.getElementById('options-container');
            container.style.visibility = 'visible';
            container.innerHTML = '';
            const correct = num1 + num2;
            let choices = new Set([correct]);
            while(choices.size < 4) {
                let alt = Math.floor(Math.random() * 10) + 1;
                choices.add(alt);
            }

            [...choices].sort(() => Math.random() - 0.5).forEach(num => {
                const btn = document.createElement('div');
                btn.className = 'vehicle-btn';
                btn.innerHTML = `<span class="icon">${vehicles[Math.floor(Math.random() * vehicles.length)]}</span><span class="num">${num}</span>`;
                const handleSelect = () => selectChoice(num, btn);
                btn.onclick = handleSelect;
                btn.ontouchstart = (e) => { e.preventDefault(); handleSelect(); };
                container.appendChild(btn);
            });
        }

        async function selectChoice(picked, element) {
            if (isTransitioning || element.style.pointerEvents === 'none') return;
            const correct = num1 + num2;
            if (picked === correct) {
                isTransitioning = true;
                // Updated logic: Read full sentence
                speak('Correct!');

                element.style.borderColor = "#4CAF50";
                element.style.background = "#c8e6c9";

                await delay(500);
                speak(`${num1} plus ${num2} is ${correct}`);
                setTimeout(newGame, 2500);
            } else {
                speak("Try again!");
                element.style.opacity = "0.3";
                element.style.pointerEvents = "none";
            }
        }

        function newGame() {
            isHandClicked = false;
            isTransitioning = false;
            globalCounter = 0;
            
            // Clear current hands immediately
            document.getElementById('leftHand').innerHTML = '';
            document.getElementById('rightHand').innerHTML = '';
            document.getElementById('message').textContent = "";
            document.getElementById('options-container').style.visibility = 'hidden';

            
            let a = includeZeros ? Math.floor(Math.random() * 6) : Math.floor(Math.random() * 5) + 1;
            let b = includeZeros ? Math.floor(Math.random() * 6) : Math.floor(Math.random() * 5) + 1;
            num1 = Math.max(a, b); num2 = Math.min(a, b);
            document.getElementById('exercise').textContent = `${num1} + ${num2} = ?`;

            // Updated logic: Read exercise first, then show hands
            speak(`${num1} plus ${num2}`, () => {
                drawHand('leftHand', num1, true);
                drawHand('rightHand', num2, false);
                // document.getElementById('message').textContent = "Count the fingers!";
            });
        }
    </script>
</body>
</html>